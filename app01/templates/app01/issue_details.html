{% extends 'app01/layout/manage.html' %}
{% load static %}

{% block mycss %}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <style>
        .avatar{
            width: 40px;
            height: 40px;
            background-color: #1A1A17;
            color: white;
            border-radius: 20px;
            text-align: center;
            line-height: 40px;
            font-size: 16px;
            float: left;
        }
        .text{
            float: left;
            margin-left: 20px;
            width: 85%;
        }
        .content{
            font-size: 16px;
        }
        .foot{
            color: #999;
        }
        .foot span{
            margin-right: 20px;
        }
        .btns{
            margin-top: 10px;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="col-md-7">
            <div class="panel panel-default">
                <div class="panel-heading">编辑数据</div>
                <div class="panel-body">
                    <form class="form-horizontal">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_for_subject" class="col-sm-2 control-label">{{ form.subject.label }}</label>
                            <div class="col-sm-10">
                                {{ form.subject }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_for_issue_type" class="col-sm-2 control-label">{{ form.issue_type.label }}</label>
                            <div class="col-sm-10">
                                {{ form.issue_type }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_for_module" class="col-sm-2 control-label">{{ form.module.label }}</label>
                            <div class="col-sm-10">
                                {{ form.module }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_for_desc" class="col-sm-2 control-label">{{ form.desc.label }}</label>
                            <div class="col-sm-10">
                                <div id="editor">{{ form.desc }}</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-6">
                                <label for="id_for_start_date" class="col-sm-4 control-label">{{ form.start_date.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.start_date }}
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <label for="id_for_end_date" class="col-sm-4 control-label">{{ form.end_date.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.end_date }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-6">
                                <label for="id_for_parent" class="col-sm-4 control-label">{{ form.parent.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.parent }}
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <label for="id_for_attention" class="col-sm-4 control-label">{{ form.mode.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.mode }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-6">
                                <label for="id_for_priority" class="col-sm-4 control-label">{{ form.priority.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.priority }}
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <label for="id_for_status" class="col-sm-4 control-label">{{ form.status.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.status }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-6">
                                <label for="id_for_assign" class="col-sm-4 control-label">{{ form.assign.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.assign }}
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <label for="id_for_attention" class="col-sm-4 control-label">{{ form.attention.label }}</label>
                                <div class="col-sm-8">
                                    {{ form.attention }}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="panel panel-default">
                <div class="panel-heading">操作记录</div>
                <div class="panel-body issue-record">
                    <div class="record-display"></div>
                    <hr>
                    <div class="submit">
                        <textarea class="form-control record-content" rows="3"></textarea>
                        <div class="btns">
                            <button class="btn btn-success" id="record_submit">提交</button>
                            <div class="btn btn-default hidden" id="replier">
                                <button type="button" class="close close_btn" aria-label="Close" id=""><span aria-hidden="true">&times;</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="reply-tmp" class="hidden">
            <div class="panel-body">
                <div class="record clearfix">
                    <div class="avatar"></div>
                    <div class="text">
                        <div class="content">
                            <div class="well well-sm"></div>
                        </div>
                        <div class="foot">
                            <span class="report-type"><i class="fa fa-bullhorn" aria-hidden="true"></i></span>
                            <span class="creator"><i class="fa fa-user" aria-hidden="true"></i></span>
                            <span class="create-time"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
                            <span class="reply-btn"><a class="reply-link"><i class="fa fa-commenting" aria-hidden="true"></i> 回复</a></span>
                        </div>
                    </div>
                    <div class="children"><div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script src="{% static 'plugin/editor.md/editormd.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.zh-CN.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-zh_CN.min.js"></script>
    <script>
        let Issue_Record_URL = "{% url 'app01:issue_record' request.project.id issue_obj.id %}";
        $(function () {
            initEditor();
            initDatePicker();
            initReplyList();
            close_button();
            bindSubmitEvent();
            replySomebody();
        })

        function initEditor() {
            editormd('editor', {
                placeholder: "请输入内容",
                height: 300,
                path: "{% static 'plugin/editor.md/lib/' %}",
                imageUpload: true,
                imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                imageUploadURL: "{% url 'app01:wiki_upload' request.project.id %}",
                onload: function () {
                    this.previewing();
                }
            });
        }

        function initDatePicker() {
            $('#id_start_date').datepicker({
                format: 'yyyy-mm-dd',
                language: 'zh-CN',
                autoclose: true
            });
            $('#id_end_date').datepicker({
                format: 'yyyy-mm-dd',
                language: 'zh-CN',
                autoclose: true
            });
        }

        function initReplyList(){
            $.ajax({
                url: Issue_Record_URL,
                type: 'GET',
                success: function(ret){
                    let record = $("#reply-tmp").find(".record").clone();
                    $.each(ret.data, function(index, value){
                        record.attr("id", "id_"+value.id)
                        record.find(".avatar").text('W');
                        record.find(".content .well").text(value.content);
                        if(value.type===1){
                            record.find(".report-type i").after(" 修改记录");
                        }else{
                            record.find(".report-type i").after(" 回复");
                        }
                        record.find(".creator i").after(" "+value.creator__username);
                        record.find(".create-time i").after(" "+value.time);
                        // 根记录
                        if(!value.parent_id){
                            $(".record-display").append(record);
                        }else{
                            $("#id_"+value.parent_id).find("children").append(record);
                        }
                    })
                }
            })
        }

        function close_button(){
            $(".close_btn").click(function(){
                $("#replier").addClass("hidden");
            })
        }
      
        function bindSubmitEvent(){
            $("#record_submit").click(function(){
                let parent_id = $("close_btn").attr("id");
                let record_type;
                if(parent_id){
                    record_type = 2;
                }else{
                    record_type = 1;
                }
                console.log(record_type)
                $.ajax({
                    url: Issue_Record_URL,
                    type: 'POST',
                    data: {
                        "parent_id": parent_id,
                        "content": $(".record-content").val(),
                        "type": record_type
                        },
                    success: function(ret){
                        if (ret.status){
                            initReplyList();
                        }else{
                            console.log(ret);
                        }
                    }
                })
            })
        }
        
        function replySomebody(){
            $(".record-display").on("click", ".reply-link", function(){
                let parent_id = $(this).parent().parent().parent().parent().attr("id").slice(3);
                
                $(".record-display .close_btn").attr("id", parent_id).text("@"+)
                console.log(parent_id);
            })
        }

    </script>
{% endblock %}